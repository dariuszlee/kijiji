Belen.Controller.Search.Watchlist=function(){function a(a){var b=document.createElement("div");return b.innerHTML=a,b.textContent||b.innerText}var b,c=[],d={},e=!1,f="ad_ids_s",g="p-vap-lnk-actn-addwtch",h="open",i="p-vap-lnk-actn-rmwtch";this.addCallback=null,this.onSaveCallback=void 0,this.removeCallback=null;var j={"init":function(){b=Belen.Controller.Search.extVars,$(".p-vap-lnk-actn-rmwtch").attr("title",b.watchlistTitleRemove),$(".watch").on("click",function(a){o(a,$(this))}),$("#watchlistContent .body").mouseenter(function(){$("#WatchlistContainer > header").addClass("hover")}),$("#watchlistContent .body").mouseleave(function(){$("#WatchlistContainer > header").removeClass("hover")}),$("#WatchlistContainer > header").click(v);var a=w();c=n(a.saved_s),e=e(a.panel_state),p();for(var d,f=$("#WatchlistItems li:not(.last) .tooltip-container"),g=0;g<f.length;g++){var h=$(f[g]),i=-1*(100+h.height())+"px";h.css("top",i)}$("#WatchlistItems").on({"mouseenter":function(){d=$(this).find(".tooltip-container"),timeout=window.setTimeout(function(){d.fadeIn("fast")},500)},"mouseleave":function(){window.clearTimeout(timeout),d.fadeOut("fast")}},"li:not(.last)")},"add":function(a){0===c.length&&(e=!0),k.call(this,"add",a);var b=Belen.Controller.Search.Watchlist;null!=b.addCallback&&b.addCallback(a)},"remove":function(a){for(var b=0;b<c.length;++b)if(-1!==c[b].indexOf(a)){c.splice(b,1);break}k.call(this,"remove",a);var d=Belen.Controller.Search.Watchlist;null!=d.removeCallback&&d.removeCallback(a)},"contains":function(a){for(var b=0;b<c.length;++b)if(c[b]===a)return!0;return!1}},k=function(a,c){var d=this,e={"adId":c,"action":a,"ca.kijiji.xsrf.token":$('input[name="ca.kijiji.xsrf.token"]').val()};$.ajax({"cache":!1,"url":b.editWatchlistAjaxUrl,"type":"post","dataType":"json","headers":{"X-Ebay-Box-Token":$('input[name="ca.kijiji.xsrf.token"]').val()},"data":$.param(e)}).done(function(b){l(a,c,b),void 0!==d.onSaveCallback&&d.onSaveCallback(c)})},l=function(a,b,d){var e=void 0===d||"OK"!==d.status&&"ok"!==d.status&&"ok"!==d&&"OK"!==d,f=$(".watch[data-adid='"+b+"']");if(e)return void m(d.value);"add"===a?(c.push(b),Kj.Tracking.trackGAEvent({"action":"WatchlistAdd"}),f.removeClass(g).addClass(h).addClass(i)):"remove"===a&&(Kj.Tracking.trackGAEvent({"action":"WatchlistRemove"}),f.removeClass(i).addClass(g).removeClass(h)),p()},m=function(a){$(".watch").removeClass(i).addClass(g).removeClass(h),Kj.initMessages({"setMessage":!0,"messageData":{"messageClass":"error","messageText":a||"no response from server"}})},n=function(a){var b=[];if(void 0!==a&&""!==a){b=a.split("&"),b.reverse();for(var c=0;c<b.length;++c)b[c]=b[c].substring(0,b[c].lastIndexOf("#"))}return b},e=function(a){return void 0!==a&&"opened"===a},o=function(a,c){a.preventDefault(),a.stopPropagation();var d=c.attr("data-action"),e=c.attr("data-adId");return""===d||(c.attr("data-action","add"===d?"rm":"add"),"add"===d&&(j.add(e),c.attr("title",b.watchlistTitleRemove)),"rm"===d&&(j.remove(e),c.attr("title",b.watchlistTitleAdd)),!1)},p=function(){0!==c.length?(e?($("#WatchlistContainer").addClass("open"),q()):$("#WatchlistContainer").removeClass("open"),$("#WatchlistContainer").show()):$("#WatchlistContainer").hide(),$("#WatchListCount").html(c.length)},q=function(){$("#WatchlistItems").find("li:not(.last)").remove();var a=c.length;a>5&&(a=5);for(var e=a;e>0;e--){var f=c[c.length-e].split("#")[0],g=d[f];void 0===g&&(g='<img src="'+b.staticContentBaseUrl+'/img/ajax-loader.gif"/>',$.ajax({"url":b.getWatchlistEntryAjaxUrl+"?adId="+f,"success":r})),g='<li data-adId="'+f+'">'+g+"</li>",$("#WatchlistItems").prepend(g),t()}},r=function(b,c,e){var f=b.ad,g="",h="";g=f.imageUri?'<div class="image"><a href="'+f.viewItemPageUri+'"><img class="ad-thumb" src="'+f.imageUri.replace("18.JPG","14.JPG")+'" alt="'+f.title+'"/></a></div>':'<div class="no-thumb"><a href="'+f.viewItemPageUri+'">'+f.title+"</a></div>",void 0!==f.price&&""!==f.price&&(h='<p style="font-size: 9px;" class="price">'+a(f.price)+"</p>");var i='<div class="tooltip-container"><div class="top"></div><div class="mid"><h4 style="font-size: 12px;">'+a(f.title)+'</h4> <p style="font-size: 9px;">'+a(f.description)+"</p>"+h+'</div><div class="btm"></div></div><div class="close-x" data-adId="'+f.adId+'"></div>'+g;$("#WatchlistItems li[data-adId='"+f.adId+"']").html(i),d[f.adId]=i,s(),t()},s=function(){$("#WatchlistItems .no-thumb > a").ellipsis()},t=function(){$(".close-x").off("click"),$(".close-x").click(function(){u($(this))})},u=function(a){var b=a.attr("data-adId");j.remove(b)},v=function(){return e=!e,p(),!1},w=function(){var a={};if(null!=$.cookie(f))for(var b=$.cookie(f).substring(1).split("^"),c=0;c<b.length;++c){var d=b[c];if(""!==d){var e=d.split("=",2);a[e[0]]=$.trim(e[1])}}return a};return j}();